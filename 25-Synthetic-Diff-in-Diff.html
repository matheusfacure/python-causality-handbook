
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>25 - Synthetic Difference-in-Differences &#8212; Causal Inference for the Brave and True</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" href="_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script src="_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Debiasing with Orthogonalization" href="Debiasing-with-Orthogonalization.html" />
    <link rel="prev" title="24 - The Difference-in-Differences Saga" href="24-The-Diff-in-Diff-Saga.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en">
    

    <!-- Google Analytics -->
    
<script async="" src="https://www.google-analytics.com/analytics.js"></script>
<script>
                        window.ga = window.ga || function () {
                            (ga.q = ga.q || []).push(arguments) };
                        ga.l = +new Date;
                        ga('create', 'UA-97848161-1', 'auto');
                        ga('set', 'anonymizeIp', true);
                        ga('send', 'pageview');
                    </script>

  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Causal Inference for the Brave and True</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="landing-page.html">
                    Causal Inference for The Brave and True
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Part I - The Yang
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="01-Introduction-To-Causality.html">
   01 - Introduction To Causality
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="02-Randomised-Experiments.html">
   02 - Randomised Experiments
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="03-Stats-Review-The-Most-Dangerous-Equation.html">
   03 - Stats Review: The Most Dangerous Equation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="04-Graphical-Causal-Models.html">
   04 - Graphical Causal Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="05-The-Unreasonable-Effectiveness-of-Linear-Regression.html">
   05 - The Unreasonable Effectiveness of Linear Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="06-Grouped-and-Dummy-Regression.html">
   06 - Grouped and Dummy Regression
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="07-Beyond-Confounders.html">
   07 - Beyond Confounders
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="08-Instrumental-Variables.html">
   08 - Instrumental Variables
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="09-Non-Compliance-and-LATE.html">
   09 - Non Compliance and LATE
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="10-Matching.html">
   10 - Matching
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="11-Propensity-Score.html">
   11 - Propensity Score
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="12-Doubly-Robust-Estimation.html">
   12 - Doubly Robust Estimation
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="13-Difference-in-Differences.html">
   13 - Difference-in-Differences
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="14-Panel-Data-and-Fixed-Effects.html">
   14 - Panel Data and Fixed Effects
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="15-Synthetic-Control.html">
   15 - Synthetic Control
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="16-Regression-Discontinuity-Design.html">
   16 - Regression Discontinuity Design
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Part II - The Yin
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="17-Predictive-Models-101.html">
   17 - Predictive Models 101
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="18-Heterogeneous-Treatment-Effects-and-Personalization.html">
   18 - Heterogeneous Treatment Effects and Personalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="19-Evaluating-Causal-Models.html">
   19 - Evaluating Causal Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="20-Plug-and-Play-Estimators.html">
   20 - Plug-and-Play Estimators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="21-Meta-Learners.html">
   21 - Meta Learners
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="22-Debiased-Orthogonal-Machine-Learning.html">
   22 - Debiased/Orthogonal Machine Learning
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="23-Challenges-with-Effect-Heterogeneity-and-Nonlinearity.html">
   23 - Challenges with Effect Heterogeneity and Nonlinearity
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="24-The-Diff-in-Diff-Saga.html">
   24 - The Difference-in-Differences Saga
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   25 - Synthetic Difference-in-Differences
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Appendix
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="Debiasing-with-Orthogonalization.html">
   Debiasing with Orthogonalization
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Debiasing-with-Propensity-Score.html">
   Debiasing with Propensity Score
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="When-Prediction-Fails.html">
   When Prediction Fails
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Prediction-Metrics-For-Causal-Models.html">
   Why Prediction Metrics are Dangerous For Causal Models
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="Conformal-Inference-for-Synthetic-Control.html">
   Conformal Inference for Synthetic Controls
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Contribute
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference external" href="https://www.patreon.com/causal_inference_for_the_brave_and_true">
   Patreon
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="https://mybinder.org/v2/gh/matheusfacure/python-causality-handbook/master?urlpath=tree/25-Synthetic-Diff-in-Diff.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Launch on Binder"
>
  

<span class="headerbtn__icon-container">
  
    <img src="_static/images/logo_binder.svg">
  </span>
<span class="headerbtn__text-container">Binder</span>
</a>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>
<a href="https://github.com/matheusfacure/python-causality-handbook/issues/new?title=Issue%20on%20page%20%2F25-Synthetic-Diff-in-Diff.html&body=Your%20issue%20content%20here."
   class="headerbtn"
   data-toggle="tooltip"
data-placement="bottom"
title="Open an issue"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-lightbulb"></i>
  </span>

</a>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="_sources/25-Synthetic-Diff-in-Diff.ipynb"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.ipynb</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#diff-in-diff-revisited">
   Diff-in-Diff Revisited
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#synthetic-controls-revisited">
   Synthetic Controls Revisited
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#synthetic-diff-in-diff">
   Synthetic Diff-in-Diff
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#time-effect-heterogeneity-and-staggered-adoption">
   Time Effect Heterogeneity and Staggered Adoption
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#placebo-variance-estimation">
   Placebo Variance Estimation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-concepts">
   Key Concepts
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contribute">
   Contribute
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>25 - Synthetic Difference-in-Differences</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#diff-in-diff-revisited">
   Diff-in-Diff Revisited
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#synthetic-controls-revisited">
   Synthetic Controls Revisited
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#synthetic-diff-in-diff">
   Synthetic Diff-in-Diff
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#time-effect-heterogeneity-and-staggered-adoption">
   Time Effect Heterogeneity and Staggered Adoption
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#placebo-variance-estimation">
   Placebo Variance Estimation
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#key-concepts">
   Key Concepts
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#references">
   References
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#contribute">
   Contribute
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="synthetic-difference-in-differences">
<h1>25 - Synthetic Difference-in-Differences<a class="headerlink" href="#synthetic-difference-in-differences" title="Permalink to this headline">#</a></h1>
<p>In previous chapters, we looked into both Difference-in-Differences and Synthetic Control methods for identifying the treatment effect with panel data (data where we have multiple units observed across multiple time periods). It turns out we can merge both approaches into a single estimator. This new Synthetic Difference-in-Differences estimation procedure manages to exploit advantages of both methods while also increasing the precision (decreasing the error bars) of the treatment effect estimate.</p>
<p>We will discuss Synthetic Difference-in-Differences mostly in the case of <strong>block treatment assignment</strong>. This means we observe multiple units across time and, at the <strong>same</strong> time, some units are treated while other units remain untreated. We can visualize this by a matrix of treatment assignments <span class="math notranslate nohighlight">\(D\)</span>, where the <strong>columns of the matrix are units</strong> and <strong>rows of the matrix are time periods</strong>.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D = \begin{bmatrix}
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0 \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0 \\
    \vdots \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 1 &amp; 1 \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 1 &amp; 1 \\
\end{bmatrix}
\end{split}\]</div>
<p>To make things more concrete, let’s follow along with the example of estimating the impact of Proposition 99 in California’s Cigarette consumption. In this case, we only have one treated unit, California, that gets treated (passed Proposition 99) at some point in time (November 1988, to be precise). If we say California is the last column of the matrix, we get something like this:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D = \begin{bmatrix}
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0 \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 0 \\
    \vdots \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 1 \\
    0 &amp; 0 &amp; 0 &amp; \dots &amp; 0 &amp; 1 \\
\end{bmatrix}
\end{split}\]</div>
<p>Notice that here we are only talking about the case where all treated units get the treatment <strong>at the same point in time</strong>. In the end, we will discuss how to handle <strong>staggered addoption treatment assignment</strong>, where the treatment is gradually rolled out to units, causing them to get it at different points in time. The only thing we’ll require in that design is that, once a unit is treated, it doesn’t roll back to being untreated.</p>
<p>Back to the simple case, where we have all units treated at the same time, we can simplify the treatment assignment matrix to four blocks, each represented by another matrix. In general, as we move down the matrix, we are moving forward in time. We will also group the treated units to the right of the matrix. As a result, the first block in our matrix (top left) correspond to the control units prior to the treatment period; the second one (top right) corresponds to the treated units prior to the treatment period; the third block (bottom left) contains the control units after the treatment period and the fourth block (bottom right) is the treated unit after the treatment period. The treatment indicator is zero everywhere except for the block with the treated units after the treatment period.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D = \begin{bmatrix}
    \pmb{0} &amp; \pmb{0} \\
    \pmb{0} &amp; \pmb{1} \\
\end{bmatrix}
\end{split}\]</div>
<p>This assignment matrix will lead to the following outcome matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Y = \begin{bmatrix}
    \pmb{Y}_{pre, co} &amp; \pmb{Y}_{pre, tr} \\
    \pmb{Y}_{post, co} &amp; \pmb{Y}_{post, tr} \\
\end{bmatrix}
\end{split}\]</div>
<p>Again, notice how the post-treatment period is on the bottom and the treated units are to the right.</p>
<p>In our example of estimating the effect of Proposition 99, the outcome <span class="math notranslate nohighlight">\(Y\)</span> is cigarette sales. We use <span class="math notranslate nohighlight">\(pre\)</span> and <span class="math notranslate nohighlight">\(post\)</span> to represent the period prior and after the treatment respectively and <span class="math notranslate nohighlight">\(co\)</span> and <span class="math notranslate nohighlight">\(tr\)</span> to represent the control and treated unit respectively.</p>
<p>We will use the above matrix representation whenever we talk about estimating the synthetic control weights, but there is also another data representation which is useful, especially if we are talking about DiD. In this representation, we have a table with 5 columns: one representing the units, one representing the time periods, the outcome column and two boolean columns flagging the treated units and the treatment period. The number of rows in this table is the number of units <span class="math notranslate nohighlight">\(N\)</span> times the number of periods <span class="math notranslate nohighlight">\(T\)</span>. Here you can see what it looks like for the Proposition 99 data:</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">toolz</span> <span class="kn">import</span> <span class="n">curry</span><span class="p">,</span> <span class="n">partial</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">import</span> <span class="nn">statsmodels.formula.api</span> <span class="k">as</span> <span class="nn">smf</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">style</span>
<span class="n">style</span><span class="o">.</span><span class="n">use</span><span class="p">(</span><span class="s2">&quot;ggplot&quot;</span><span class="p">)</span>

<span class="n">pd</span><span class="o">.</span><span class="n">set_option</span><span class="p">(</span><span class="s1">&#39;display.max_columns&#39;</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;data/smoking.csv&quot;</span><span class="p">)[[</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;cigsale&quot;</span><span class="p">,</span> <span class="s2">&quot;california&quot;</span><span class="p">,</span> <span class="s2">&quot;after_treatment&quot;</span><span class="p">]]</span>
        <span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;california&quot;</span><span class="p">:</span> <span class="s2">&quot;treated&quot;</span><span class="p">})</span>
        <span class="o">.</span><span class="n">replace</span><span class="p">({</span><span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="p">{</span><span class="mi">3</span><span class="p">:</span> <span class="s2">&quot;california&quot;</span><span class="p">}}))</span>

<span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>year</th>
      <th>cigsale</th>
      <th>treated</th>
      <th>after_treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1</td>
      <td>1970</td>
      <td>89.800003</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1</td>
      <td>1971</td>
      <td>95.400002</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1</td>
      <td>1972</td>
      <td>101.099998</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1</td>
      <td>1973</td>
      <td>102.900002</td>
      <td>False</td>
      <td>False</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1</td>
      <td>1974</td>
      <td>108.199997</td>
      <td>False</td>
      <td>False</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;state==&#39;california&#39;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;year.between(1986, 1990)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>year</th>
      <th>cigsale</th>
      <th>treated</th>
      <th>after_treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>78</th>
      <td>california</td>
      <td>1986</td>
      <td>99.699997</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>79</th>
      <td>california</td>
      <td>1987</td>
      <td>97.500000</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>80</th>
      <td>california</td>
      <td>1988</td>
      <td>90.099998</td>
      <td>True</td>
      <td>False</td>
    </tr>
    <tr>
      <th>81</th>
      <td>california</td>
      <td>1989</td>
      <td>82.400002</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>82</th>
      <td>california</td>
      <td>1990</td>
      <td>77.800003</td>
      <td>True</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>If we want to go from this table to the matrix representation we discussed earlier, all we have to do is pivot the table by time (year) and unit (state). We’ll be going back and forth between these two representations, as one is more convenient for DiD and the other, for Synthetic Controls estimation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data_piv</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;cigsale&quot;</span><span class="p">)</span>
<span class="n">data_piv</span> <span class="o">=</span> <span class="n">data_piv</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">c</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;state_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">data_piv</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="o">!=</span> <span class="s2">&quot;california&quot;</span><span class="p">})</span>

<span class="n">data_piv</span><span class="o">.</span><span class="n">head</span><span class="p">()[[</span><span class="s2">&quot;state_1&quot;</span><span class="p">,</span> <span class="s2">&quot;state_2&quot;</span><span class="p">,</span> <span class="s2">&quot;state_4&quot;</span><span class="p">,</span> <span class="s2">&quot;state_38&quot;</span><span class="p">,</span> <span class="s2">&quot;state_39&quot;</span><span class="p">,</span> <span class="s2">&quot;california&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th>state</th>
      <th>state_1</th>
      <th>state_2</th>
      <th>state_4</th>
      <th>state_38</th>
      <th>state_39</th>
      <th>california</th>
    </tr>
    <tr>
      <th>year</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1970</th>
      <td>90.0</td>
      <td>100.0</td>
      <td>125.0</td>
      <td>106.0</td>
      <td>132.0</td>
      <td>123.0</td>
    </tr>
    <tr>
      <th>1971</th>
      <td>95.0</td>
      <td>104.0</td>
      <td>126.0</td>
      <td>105.0</td>
      <td>132.0</td>
      <td>121.0</td>
    </tr>
    <tr>
      <th>1972</th>
      <td>101.0</td>
      <td>104.0</td>
      <td>134.0</td>
      <td>109.0</td>
      <td>140.0</td>
      <td>124.0</td>
    </tr>
    <tr>
      <th>1973</th>
      <td>103.0</td>
      <td>108.0</td>
      <td>138.0</td>
      <td>110.0</td>
      <td>141.0</td>
      <td>124.0</td>
    </tr>
    <tr>
      <th>1974</th>
      <td>108.0</td>
      <td>110.0</td>
      <td>133.0</td>
      <td>112.0</td>
      <td>146.0</td>
      <td>127.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In terms of potential outcomes, we can go back to the outcome matrix to review the causal inference goal here. Since the treatment is only rolled out to the treated unit after the treatment period, we observe the potential outcome <span class="math notranslate nohighlight">\(Y_0\)</span> everywhere in the matrix, except for the bottom right block.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
Y = \begin{bmatrix}
    \pmb{Y}(0)_{pre, co} &amp; \pmb{Y}(0)_{pre, tr} \\
    \pmb{Y}(0)_{post, co} &amp; \pmb{Y}(1)_{post, tr} \\
\end{bmatrix}
\end{split}\]</div>
<p>Our goal is to estimate the <span class="math notranslate nohighlight">\(ATT =  \pmb{Y}(1)_{post, tr} -  \pmb{Y}(0)_{post, tr}\)</span>. For that, we need to somehow estimate the missing potential outcome <span class="math notranslate nohighlight">\(\pmb{Y}(0)_{post, tr}\)</span>. In words, we need to know what would have happened to the treated unit in the post-treatment period had it not been treated. With that in mind, a good place to start is by reviewing both Diff-in-Diff and Synthetic Control. At first, it looks like they are each doing very different things to estimate that missing potential outcome. Combining them sure feels weird. However, both methods have more in common than we might think.</p>
<section id="diff-in-diff-revisited">
<h2>Diff-in-Diff Revisited<a class="headerlink" href="#diff-in-diff-revisited" title="Permalink to this headline">#</a></h2>
<p>In the Diff-in-Diff chapter, we got the treatment effect by estimating the following linear model.</p>
<div class="math notranslate nohighlight">
\[
Y_{it} = \beta_0 + \beta_1 Post_t + \beta_2 Treated_i + \beta_3 Treated_i  Post_t + e_{it}
\]</div>
<p>Where <code class="docutils literal notranslate"><span class="pre">post</span></code> is a time dummy indicating that the period is after the treatment and <code class="docutils literal notranslate"><span class="pre">treated</span></code> is a unit dummy marking units as being part of the treated group. If we estimate this model in the California example, we get -27.34 as the estimated <span class="math notranslate nohighlight">\(ATT\)</span>, indicating a strong negative effect of Proposition 99. This would mean that per capita consumption of cigarettes fell by 27 packs due to Proposition 99.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">did_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="s2">&quot;cigsale ~ after_treatment*treated&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
<span class="n">att</span> <span class="o">=</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;after_treatment[T.True]:treated[T.True]&quot;</span><span class="p">]</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;DiD ATT: &quot;</span><span class="p">,</span> <span class="n">att</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DiD ATT:  -27.349
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">pre_year</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~after_treatment&quot;</span><span class="p">)[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">post_year</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">pre_control_y</span> <span class="o">=</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
<span class="n">post_control_y</span> <span class="o">=</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;after_treatment[T.True]&quot;</span><span class="p">]</span>

<span class="n">pre_treat_y</span> <span class="o">=</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treated[T.True]&quot;</span><span class="p">]</span>

<span class="n">post_treat_y0</span> <span class="o">=</span> <span class="n">post_control_y</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treated[T.True]&quot;</span><span class="p">]</span>

<span class="n">post_treat_y1</span> <span class="o">=</span> <span class="n">post_treat_y0</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;after_treatment[T.True]:treated[T.True]&quot;</span><span class="p">]</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pre_year</span><span class="p">,</span> <span class="n">post_year</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_control_y</span><span class="p">,</span> <span class="n">post_control_y</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Control&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pre_year</span><span class="p">,</span> <span class="n">post_year</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_treat_y</span><span class="p">,</span> <span class="n">post_treat_y0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">pre_year</span><span class="p">,</span> <span class="n">post_year</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_treat_y</span><span class="p">,</span> <span class="n">post_treat_y1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;DiD Estimation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_9_0.png" src="_images/25-Synthetic-Diff-in-Diff_9_0.png" />
</div>
</div>
<p>This estimate should be taken with a grain of salt, though. We know that Diff-in-Diff requires the trend in the control group to be equal to that of the treated group in the absence of the treatment. Formally, <span class="math notranslate nohighlight">\(E[Y(0)_{post, co} - Y(0)_{pre, co}] = E[Y(0)_{post, tr} - Y(0)_{pre, tr}]\)</span>. This is an untestable assumption, but looking at the pre-treatment trend of California (the treated unit) and the other states, we can get a feeling for how plausible it is. Specifically, we can see that the trend in <code class="docutils literal notranslate"><span class="pre">cigsale</span></code> for California is not parallel to the other states, at least in the pre-treatment periods. Cigarette sales in California are decreasing faster than the average of the control states, even prior to the treatment. If this trend extends beyond the pre-treatment period, the DiD estimator will be downward biased, meaning that the true effect is actually less extreme than the one we’ve estimated above.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">]),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Control Avg.&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Non-Parallel Trends&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_11_0.png" src="_images/25-Synthetic-Diff-in-Diff_11_0.png" />
</div>
</div>
<p>The problem of non-parallel trends is where Synthetic Control comes into play in the Synthetic Diff-in-Diff model. But we are getting ahead of ourselves. Regardless of DiD being a valid model for the data above, what is interesting about it is that we can recast it into the Two-Way Fixed-Effects formulation. To frame DiD like this, we fit unit (<span class="math notranslate nohighlight">\(\alpha_i\)</span>) and time (<span class="math notranslate nohighlight">\(\beta_t\)</span>) averages, alongside the treatment indicator.</p>
<div class="math notranslate nohighlight">
\[
\hat{\tau}^{did} = \underset{\mu, \alpha, \beta, \tau}{argmin} \bigg\{ \sum_{i=1}^N \sum_{t=1}^T \big(Y_{it} - (\mu + \alpha_i + \beta_t + \tau D_{it}\big)^2 \bigg\}
\]</div>
<p>In this formulation, the unit effects capture the difference in intercepts for each unit while the time effects capture the general trend across both treated and control units. To implement this, we could either add time and unit dummies to the model or demean the data. In this process, we subtract the average across both time and units from both treatment and outcome variables:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\ddot{Y}_{it} = Y_{it} - \bar{Y}_i  - \bar{Y}_t\\
\ddot{D}_{it} = D_{it} - \bar{D}_i - \bar{D}_t
\end{split}\]</div>
<p>Where, <span class="math notranslate nohighlight">\(\bar{X}_i\)</span> is the average across all time periods for unit <span class="math notranslate nohighlight">\(i\)</span> and <span class="math notranslate nohighlight">\(\bar{X}_t\)</span> is the average across all units for time <span class="math notranslate nohighlight">\(t\)</span>:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\ddot{Y}_{it} = Y_{it} - T^{-1}\sum_{t=0}^{t=T} Y_{it}  - N^{-1}\sum_{i=0}^{i=N} Y_{it}\\
\ddot{D}_{it} = D_{it} - T^{-1}\sum_{t=0}^{t=T} D_{it} - N^{-1}\sum_{i=0}^{i=N} D_{it}
\end{split}\]</div>
<p>After demeaning, a simple regression of the outcome on the treatment indicator (<code class="docutils literal notranslate"><span class="pre">treat*post</span></code>) yields the difference in difference estimator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@curry</span>
<span class="k">def</span> <span class="nf">demean</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_to_demean</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col_to_demean</span><span class="p">:</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_to_demean</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)[</span><span class="n">col_to_demean</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">)</span>
                                        <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="n">col_to_demean</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">))})</span>

<span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;cigsale ~ treat&quot;&quot;&quot;</span>
<span class="n">mod</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">ols</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span>
              <span class="n">data</span><span class="o">=</span><span class="n">data</span>
              <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">treat</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;treated&quot;</span><span class="p">])</span>
              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">demean</span><span class="p">(</span><span class="n">col_to_demean</span><span class="o">=</span><span class="s2">&quot;treat&quot;</span><span class="p">))</span>
              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">demean</span><span class="p">(</span><span class="n">col_to_demean</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">)))</span>

<span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
      <td></td>         <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th> <td> -119.1647</td> <td>    0.333</td> <td> -358.379</td> <td> 0.000</td> <td> -119.817</td> <td> -118.512</td>
</tr>
<tr>
  <th>treat</th>     <td>  -27.3491</td> <td>    4.283</td> <td>   -6.385</td> <td> 0.000</td> <td>  -35.753</td> <td>  -18.945</td>
</tr>
</table></div></div>
</div>
<p>As you can see, we get the exact same parameter as before. After all, both approaches are simply different ways of looking at the same DiD estimator. However, the reason this formulation is much more interesting for our purpose is that it allows us to see how DiD is actually quite similar to Synthetic Controls. Take a very close look at the TWFE formulation above. Notice that it is a regression problem with time effects and unit effects. But notice how there are no weights in the optimization objective. That is the main difference between Diff-in-Diff and Synthetic Controls, as we will see shortly.</p>
</section>
<section id="synthetic-controls-revisited">
<h2>Synthetic Controls Revisited<a class="headerlink" href="#synthetic-controls-revisited" title="Permalink to this headline">#</a></h2>
<p>In the canonical Synthetic Control estimator, we find unit (state) weights that minimize the difference between the pre-treated outcome of the treated unit and the weighted average of the pre-treated outcome of the control units (in a setting with no covariates). We also constrain the weights to be all positive and sum up to one. To find those weights, we solve the following optimization problem:</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\hat{w}^{sc} = \underset{w}{\mathrm{argmin}} \ ||\pmb{\bar{y}}_{pre, tr} - \pmb{Y}_{pre, co} \pmb{w}_{co}||^2_2 \\
\text{s.t } \ \sum w_i = 1 \text{ and } \ w_i &gt; 0 \ \forall \ i
\end{split}\]</div>
<p>where the outcome <span class="math notranslate nohighlight">\(\pmb{Y}_{pre, co}\)</span> is a <span class="math notranslate nohighlight">\(T_{pre}\)</span> by <span class="math notranslate nohighlight">\(N_{co}\)</span> matrix, where the columns are the units and the rows are the time periods. <span class="math notranslate nohighlight">\(\pmb{w}_{co}\)</span> is a <span class="math notranslate nohighlight">\(N_{co}\)</span> by 1 column vector, with one entry for each unit. Finally, <span class="math notranslate nohighlight">\(\pmb{\bar{y}}_{pre, tr}\)</span> is a <span class="math notranslate nohighlight">\(T_{pre}\)</span> by 1 column vector, where each entry is the time average of the treated units in the pre-treatment period. This is why we sometimes call Synthetic Control a horizontal regression. In most regression problems, the units are the rows of the matrix, but here they are the columns. Hence, we are regressing the average outcome of the treated units on the control units.</p>
<p>Once we find the weights that solve the problem above, we can multiply them by the control units at all time periods to get a synthetic control for the treated unit:</p>
<div class="math notranslate nohighlight">
\[
\pmb{y}_{sc} = \pmb{Y}_{co}\hat{\pmb{w}}^{sc}
\]</div>
<p>The idea here is that <span class="math notranslate nohighlight">\(\pmb{y}_{post, sc}\)</span> is a good estimator for our missing potential outcome <span class="math notranslate nohighlight">\(Y(0)_{post, tr}\)</span>. If that is the case, the <span class="math notranslate nohighlight">\(ATT\)</span> is simply the average of the treated unit in the post-treatment period minus the average of the synthetic control, also in the post treatment period.</p>
<div class="math notranslate nohighlight">
\[
\hat{\tau} =  \bar{y}_{post, tr} - \bar{y}_{post, sc}
\]</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sc</span> <span class="kn">import</span> <span class="n">SyntheticControl</span>

<span class="n">sc_model</span> <span class="o">=</span> <span class="n">SyntheticControl</span><span class="p">()</span>

<span class="n">y_co_pre</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;cigsale&quot;</span><span class="p">)</span>
<span class="n">y_tr_pre</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span>

<span class="n">sc_model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">y_co_pre</span><span class="p">,</span> <span class="n">y_tr_pre</span><span class="p">)</span>
<span class="n">sc_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">sc_model</span><span class="o">.</span><span class="n">w_</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">y_co_pre</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;sc_w&quot;</span><span class="p">)</span>

<span class="n">sc</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;cigsale&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">sc_weights</span><span class="p">)</span>

<span class="n">att</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">][</span><span class="n">sc</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1988</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">-</span> <span class="n">sc</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1988</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;SC ATT: &quot;</span><span class="p">,</span> <span class="n">att</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SC ATT:  -19.5136
</pre></div>
</div>
</div>
</div>
<p>This estimate is much smaller than the one we got with Diff-in-Diff. Synthetic Controls can accommodate non-parallel pre-treatment trends much better, so it is not susceptible to the same bias as Diff-in-Diff. Rather, the process of baking a Synthetic Control enforces parallel trends, at least in the pre-treatment period. As a result, the estimate we get is much smaller and much more plausible.</p>
<p>We can visualize this estimation process by plotting the realized outcome for California alongside the outcome of the synthetic control. We also plot as dashed lines the post intervention average of both California and the synthetic control. The difference between these lines is the estimated <span class="math notranslate nohighlight">\(ATT\)</span>.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Synthetic Control&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sc</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>

<span class="n">calif_avg</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">][</span><span class="n">sc</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1988</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">sc_avg</span> <span class="o">=</span> <span class="n">sc</span><span class="p">[</span><span class="n">sc</span><span class="o">.</span><span class="n">index</span> <span class="o">&gt;</span> <span class="mi">1988</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">calif_avg</span><span class="p">,</span> <span class="mi">1988</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">sc_avg</span><span class="p">,</span> <span class="mi">1988</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;SC Estimation&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_17_0.png" src="_images/25-Synthetic-Diff-in-Diff_17_0.png" />
</div>
</div>
<p>Interestingly enough, we can also recast the Synthetic Control estimator as solving the following optimization problem, which is quite similar to the Two-Way Fixed-Effects formulation we used for Diff-in-Diff</p>
<div class="math notranslate nohighlight">
\[
\hat{\tau}^{sc} = \underset{\beta, \tau}{argmin}  \bigg\{ \sum_{i=1}^N \sum_{t=1}^T \big(Y_{it} - \beta_t - \tau D_{it}\big)^2 \hat{w}^{sc}_i \bigg\}
\]</div>
<p>where the <span class="math notranslate nohighlight">\(\hat{w}^{sc}_i\)</span> weights for the control units are estimated from the optimization problem we saw earlier. For the treated unit,  the weights are simply <span class="math notranslate nohighlight">\(1/N_{tr}\)</span> (uniform weighting).</p>
<p>Notice the difference between SC and DiD here. First, Synthetic Control adds unit weights <span class="math notranslate nohighlight">\(\hat{w}^{sc}_i\)</span> to the equation. Second, we have time fixed effects <span class="math notranslate nohighlight">\(\beta_t\)</span> but no unit fixed effect <span class="math notranslate nohighlight">\(\alpha_i\)</span>, nor an overall intercept  <span class="math notranslate nohighlight">\(\mu\)</span>.</p>
<p>To verify that these two formulations are actually equivalent, here is the code for it, which yields the exact same <span class="math notranslate nohighlight">\(ATT\)</span> estimate.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nd">@curry</span>
<span class="k">def</span> <span class="nf">demean_time</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">col_to_demean</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">col_to_demean</span><span class="p">:</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col_to_demean</span><span class="p">]</span>
                                        <span class="o">-</span> <span class="n">df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="n">col_to_demean</span><span class="p">]</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="s2">&quot;mean&quot;</span><span class="p">))})</span>

<span class="n">data_w_cs_weights</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">sc_weights</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">sc_weights</span><span class="p">))</span>

<span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;cigsale ~ -1 + treat&quot;&quot;&quot;</span>

<span class="n">mod</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">wls</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span>
              <span class="n">data</span><span class="o">=</span><span class="n">data_w_cs_weights</span>
              <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="n">treat</span> <span class="o">=</span> <span class="n">data_w_cs_weights</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">]</span><span class="o">*</span><span class="n">data_w_cs_weights</span><span class="p">[</span><span class="s2">&quot;treated&quot;</span><span class="p">])</span>
              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">demean_time</span><span class="p">(</span><span class="n">col_to_demean</span><span class="o">=</span><span class="s2">&quot;treat&quot;</span><span class="p">))</span>
              <span class="o">.</span><span class="n">pipe</span><span class="p">(</span><span class="n">demean_time</span><span class="p">(</span><span class="n">col_to_demean</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">)),</span>
              <span class="n">weights</span><span class="o">=</span><span class="n">data_w_cs_weights</span><span class="p">[</span><span class="s2">&quot;sc_w&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span>

<span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
    <td></td>       <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>treat</th> <td>  -19.5136</td> <td>   13.289</td> <td>   -1.468</td> <td> 0.142</td> <td>  -45.586</td> <td>    6.559</td>
</tr>
</table></div></div>
</div>
<p>We just saw how the two approaches, SC and DiD, are actually closely related. Now, we are ready to talk about Synthetic Diff-in-Diff. As you can probably guess, we will just add weights to the DiD estimator or unit fixed-effects to the Synthetic Control estimator.</p>
<p><img alt="img" src="_images/both-pills.png" /></p>
</section>
<section id="synthetic-diff-in-diff">
<h2>Synthetic Diff-in-Diff<a class="headerlink" href="#synthetic-diff-in-diff" title="Permalink to this headline">#</a></h2>
<p>Before we jump right into the Synthetic Diff-in-Diff estimator, let me just reproduce the same equations we saw earlier for SC and DiD, which will ease the comparison.</p>
<div class="math notranslate nohighlight">
\[
\hat{\tau}^{sc} = \underset{\beta, \tau}{argmin}  \bigg\{ \sum_{i=1}^N \sum_{t=1}^T \big(Y_{it} - \beta_t - \tau D_{it}\big)^2 \hat{w}^{sc}_i \bigg\}
\]</div>
<div class="math notranslate nohighlight">
\[
\hat{\tau}^{did} = \underset{\mu, \alpha, \beta, \tau}{argmin} \bigg\{ \sum_{i=1}^N \sum_{t=1}^T \big(Y_{it} - (\mu + \alpha_i + \beta_t + \tau D_{it}\big)^2 \bigg\}
\]</div>
<p>Next, just like I promised, we can easily merge the equations above into one which will contain elements from both of them:</p>
<div class="math notranslate nohighlight">
\[
\hat{\tau}^{sdid} = \underset{\mu, \alpha, \beta, \tau}{argmin}  \bigg\{ \sum_{i=1}^N \sum_{t=1}^T \big(Y_{it} - (\mu + \alpha_i + \beta_t + \tau D_{it})^2 \hat{w}^{sdid}_i \hat{\lambda}^{sdid}_t \big) \bigg\}
\]</div>
<p>As you can see, we’ve added back the <span class="math notranslate nohighlight">\(\alpha_i\)</span> unit fixed effects. We’ve also kept the unit weights <span class="math notranslate nohighlight">\(\hat{w}_i\)</span>. But there is something new, which is the time weights <span class="math notranslate nohighlight">\(\hat{\lambda}_t\)</span>. Don’t worry. There is nothing fancy about them. Remember how the unit weights <span class="math notranslate nohighlight">\(w_i\)</span> minimized the difference between the control units and the average of treated units? In other words, we use them to match the pre-trend of the treated and control groups. The time weight does the same thing, but for the periods. That is, it minimizes the difference between the pre and post-treated periods for the controls.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\hat{\lambda}^{sdid} = \underset{\lambda}{\mathrm{argmin}} \ ||\bar{\pmb{y}}_{post, co} - (\pmb{\lambda}_{pre} \pmb{Y}_{pre, co} +  \lambda_0)||^2_2 \\
\text{s.t } \ \sum \lambda_t = 1 \text{ and } \ \lambda_t &gt; 0 \ \forall \ t
\end{split}\]</div>
<p>Again, <span class="math notranslate nohighlight">\(\pmb{Y}_{pre, co}\)</span> is a <span class="math notranslate nohighlight">\(T_{pre}\)</span> by <span class="math notranslate nohighlight">\(N_{co}\)</span> matrix of outcomes where the rows represent time periods and the columns represent the units. But now <span class="math notranslate nohighlight">\(\bar{\pmb{y}}_{post, co}\)</span> is a 1 by <span class="math notranslate nohighlight">\(N_{co}\)</span> row vector, where each entry is the time average outcome for that control unit in the post-treatment period. Finally, <span class="math notranslate nohighlight">\(\pmb{\lambda}_{pre}\)</span> is a 1 by <span class="math notranslate nohighlight">\(T_{pre}\)</span> row vector, with one entry for each pretreatment period. Another way to see this is by noticing that the unit weights <span class="math notranslate nohighlight">\(w\)</span> were post-multiplying the outcome matrix <span class="math notranslate nohighlight">\(\pmb{Y}_{pre, co} \pmb{w}_{co}\)</span>. This means we were regressing the average outcome <strong>for each unit</strong> of the treated group on the outcome of the units in the control group. Now, we are flipping that problem on its head, regressing the average outcome <strong>for each post-treatment time period</strong> of the control group on the outcome of the same control units, but in the pre-treatment period.</p>
<p>As for the time weights in the post-treated periods, we just set them to one over the number of post-treated periods <span class="math notranslate nohighlight">\(1/T_{post}\)</span> (again, doing uniform weighting). Notice that we also have an intercept <span class="math notranslate nohighlight">\(\lambda_0\)</span>. We do this to allow the post-treatment period to be above or below all the pre-treatment periods, which is the case in many applications with a clear positive or negative trend.</p>
<p>If all of this seems a bit abstract, maybe code will help you understand what is going on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_time_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
        
        <span class="n">control</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        
        <span class="c1"># pivot the data to the (T_pre, N_co) matrix representation</span>
        <span class="n">y_pre</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span>
                 <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                 <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">))</span>
        
        <span class="c1"># group post-treatment time period by units to have a (1, N_co) vector.</span>
        <span class="n">y_post_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">control</span>
                       <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                       <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">state_col</span><span class="p">)</span>
                       <span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span>
                       <span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                       <span class="o">.</span><span class="n">values</span><span class="p">)</span>
        
        <span class="c1"># add a (1, N_co) vector of 1 to the top of the matrix, to serve as the intercept.</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span> <span class="n">y_pre</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])),</span> <span class="n">y_pre</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        
        <span class="c1"># estimate time weights</span>
        <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">objective</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">w</span><span class="nd">@X</span> <span class="o">-</span> <span class="n">y_post_mean</span><span class="p">))</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
        <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        
        <span class="c1"># print(&quot;Intercept: &quot;, w.value[0])</span>
        <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="c1"># remove intercept</span>
                         <span class="n">name</span><span class="o">=</span><span class="s2">&quot;time_weights&quot;</span><span class="p">,</span>
                         <span class="n">index</span><span class="o">=</span><span class="n">y_pre</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The first thing we do in this code is to filter out the treated group. Then, we pivot the pre-treated data so that we have the matrix <span class="math notranslate nohighlight">\(\pmb{Y}_{pre,co}\)</span>. Next, we group the post-treatment data to get the average outcome for each control unit in the post-treatment period. We then add a row full of ones to the top of <span class="math notranslate nohighlight">\(\pmb{Y}_{pre,co}\)</span>, which will serve as the intercept. Finally, we regress <span class="math notranslate nohighlight">\(\bar{\pmb{y}}_{post, co}\)</span> on the pre-treated periods (the rows of <span class="math notranslate nohighlight">\(\pmb{Y}_{pre,co}\)</span>) to get the time weights <span class="math notranslate nohighlight">\(\lambda_t\)</span>. Notice how we add the constraints to have the weights sum up to 1 and be non-negative. Finally, we toss the intercept away and store the time weights in a series.</p>
<p>Here is the result we get by running the code above to find the time weights in the Proposition 99 problem. Notice that all periods except for 1986, 87 ans 88 get zero weights. This means that a weighted average of only the last 3 periods is enough to balance pre and post treatment periods.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">time_weights</span> <span class="o">=</span> <span class="n">fit_time_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>

<span class="n">time_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>year
1984   -0.000
1985   -0.000
1986    0.366
1987    0.206
1988    0.427
Name: time_weights, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>To understand a bit more about the role of these weights, we can plot <span class="math notranslate nohighlight">\(\hat{\pmb{\lambda}}_{pre} \pmb{Y}_{pre, co} +  \hat{\lambda}_0\)</span> as a horizontal line in the pretreatment period that doesn’t get zeroed out. Next to it, we plot the average outcome in the post-treatment period. Notice how they align perfectly. We also show the estimated time weights in red bars and in the secondary axis.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>

<span class="n">intercept</span> <span class="o">=</span> <span class="o">-</span><span class="mf">15.023877689807628</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">((</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">*</span> <span class="n">time_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">-</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">1986</span><span class="p">,</span> <span class="mi">1988</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;&quot; $\lambda_</span><span class="si">{pre}</span><span class="s2"> Y_{pre, co} + \lambda_0$&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hlines</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;~treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="mi">1988</span><span class="p">,</span> <span class="mi">2000</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;&quot;&quot;Avg  $Y_{post, co}$&quot;&quot;&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">140</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Time Period Balancing&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">);</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">time_weights</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">time_weights</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;$\lambda$&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time Weights&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_25_0.png" src="_images/25-Synthetic-Diff-in-Diff_25_0.png" />
</div>
</div>
<p>Now that we learned what are the time weights <span class="math notranslate nohighlight">\(\lambda_t\)</span> in the Synthetic Diff-in-Diff estimator and how to estimate them, let’s turn our attention to the unit weights <span class="math notranslate nohighlight">\(w_i\)</span>. And no, unfortunately they are not just like the ones we get when using traditional Synthetic Controls. The first difference between them is that we also allow for an intercept <span class="math notranslate nohighlight">\(w_0\)</span>. We do this because we don’t need the treated unit and synthetic control to have the same level anymore. Since we will throw DiD into the mix, we only need to make the synthetic control and treated unit have parallel trends.</p>
<p>The next difference is that we add a <span class="math notranslate nohighlight">\(L_2\)</span> penalty to the weights. This helps non-zero weights to be more distributed across the control units, as opposed to having just a few of them contributing to the synthetic control. The <span class="math notranslate nohighlight">\(L_2\)</span> penalty ensures we don’t have very big weights, which forces us to use more units.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
\hat{w}^{sdid} = \underset{w}{\mathrm{argmin}} \ ||\bar{\pmb{y}}_{pre, tr} - (\pmb{Y}_{pre, co} \pmb{w}_{co} +  w_0)||^2_2 + \zeta^2 T_{pre} ||\pmb{w}_{co}||^2_2\\
\text{s.t } \ \sum w_i = 1 \text{ and } \ w_i &gt; 0 \ \forall \ i
\end{split}\]</div>
<p>There is also this <span class="math notranslate nohighlight">\(\zeta^2\)</span> term, which is theoretically motivated, but very complicated to explain, so I will unfortunately leave it as a bit of a mystery. In the reference, you can check the original article, which explains them. We define it like this:</p>
<div class="math notranslate nohighlight">
\[
\zeta = (N_{tr}* T_{post})^{1/4}\sigma(\Delta_{it})
\]</div>
<p>where <span class="math notranslate nohighlight">\(\Delta_{it}\)</span> is the first difference in the outcomes <span class="math notranslate nohighlight">\(Y_{it} - Y_{i(t-1)}\)</span> and <span class="math notranslate nohighlight">\(\sigma(\Delta_{it})\)</span> is the standard deviation of this difference. Here is the code to compute it.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">calculate_regularization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
    
    <span class="n">n_treated_post</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">post_col</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">treat_col</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">first_diff_std</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                      <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">year_col</span><span class="p">)</span>
                      <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">state_col</span><span class="p">)</span>
                      <span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span>
                      <span class="o">.</span><span class="n">diff</span><span class="p">()</span>
                      <span class="o">.</span><span class="n">std</span><span class="p">())</span>
    
    <span class="k">return</span> <span class="n">n_treated_post</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="n">first_diff_std</span>
</pre></div>
</div>
</div>
</div>
<p>As for the unit weights, there is nothing particularly new in them. We can reuse a lot of the code from the function to estimate the time weights. We only need to be careful about the dimensions, since the problem is now upside down.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">fit_unit_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
    
    <span class="n">zeta</span> <span class="o">=</span> <span class="n">calculate_regularization</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">)</span>
    <span class="n">pre_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="c1"># pivot the data to the (T_pre, N_co) matrix representation</span>
    <span class="n">y_pre_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_data</span>
                     <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">))</span>
    
    <span class="c1"># group treated units by time periods to have a (T_pre, 1) vector.</span>
    <span class="n">y_pre_treat_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">pre_data</span>
                        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">year_col</span><span class="p">)</span>
                        <span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
    <span class="c1"># add a (T_pre, 1) column to the begining of the (T_pre, N_co) matrix to serve as intercept</span>
    <span class="n">T_pre</span> <span class="o">=</span> <span class="n">y_pre_control</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">T_pre</span><span class="p">,</span> <span class="mi">1</span><span class="p">)),</span> <span class="n">y_pre_control</span><span class="o">.</span><span class="n">values</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> 
    
    <span class="c1"># estimate unit weights. Notice the L2 penalty using zeta</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">objective</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">X</span><span class="nd">@w</span> <span class="o">-</span> <span class="n">y_pre_treat_mean</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">+</span> <span class="n">T_pre</span><span class="o">*</span><span class="n">zeta</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]))</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># print(&quot;Intercept:&quot;, w.value[0])</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="mi">1</span><span class="p">:],</span> <span class="c1"># remove intercept</span>
                     <span class="n">name</span><span class="o">=</span><span class="s2">&quot;unit_weights&quot;</span><span class="p">,</span>
                     <span class="n">index</span><span class="o">=</span><span class="n">y_pre_control</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>First, we calculate <span class="math notranslate nohighlight">\(\zeta\)</span> using the function we defined earlier and filter out the post-treatment period. Next, we pivot the pre-treatment data to get the <span class="math notranslate nohighlight">\(\bar{\pmb{y}}_{pre, tr}\)</span> matrix of outcomes. Then, we add a column full of ones to the beginning of the <span class="math notranslate nohighlight">\(\bar{\pmb{y}}_{pre, tr}\)</span> matrix. This column will allow us to estimate the intercept. With all of that, we define the optimization objective, which includes the <span class="math notranslate nohighlight">\(L_2\)</span> penalty on the weights. Finally, we toss the intercept away and store the estimated weights in a series.</p>
<p>If we use this code to estimate the unit weights in the Proposition 99 problem, here is the result we get for the first 5 states:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">unit_weights</span> <span class="o">=</span> <span class="n">fit_unit_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>

<span class="n">unit_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>state
1   -0.000
2   -0.000
4    0.057
5    0.078
6    0.070
Name: unit_weights, dtype: float64
</pre></div>
</div>
</div>
</div>
<p>These unit weights also define a synthetic control that we can plot alongside the outcome of California. We’ll also plot the traditional synthetic control we’ve estimated earlier alongside the one we’ve just estimated plus the intercept term. This will give us some intuition on what is going on and the difference between what we just did and traditional Synthetic Control.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">intercept</span> <span class="o">=</span> <span class="o">-</span><span class="mf">24.75035353644767</span>
<span class="n">sc_did</span> <span class="o">=</span> <span class="n">data_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="s2">&quot;california&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">values</span> <span class="o">@</span> <span class="n">unit_weights</span><span class="o">.</span><span class="n">values</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sc_did</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Synthetic Control (SDID)&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SDID Synthetic Control&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">);</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sc_did</span><span class="o">+</span><span class="n">intercept</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Synthetic Control (SDID) + $w_0$&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">.8</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Traditional SC&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">160</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;SDID and Traditional SCs&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_33_0.png" src="_images/25-Synthetic-Diff-in-Diff_33_0.png" />
</div>
</div>
<p>As we can see in the first plot, the obvious difference is that this new synthetic control is no longer on top of California. That’s because we’ve included an intercept, which allows the treated unit to be on an arbitrarily different level than its synthetic control. This new Synthetic Control method is built to have the same pretreatment trend as the treated unit, but not necessarily the same level.</p>
<p>In the second plot, we shift this new SC by adding back the intercept we’ve removed earlier. This puts it on top of the treated unit, California. For comparison, we show the traditional SC we’ve fitted earlier as the red dashed line. Notice that they are not the same. This difference comes both from the fact that we allowed for an intercept and from the <span class="math notranslate nohighlight">\(L_2\)</span> penalty, which pushed the weights towards zero.</p>
<p>Now that we have both time <span class="math notranslate nohighlight">\(\hat{\lambda}_t\)</span> and unit <span class="math notranslate nohighlight">\(\hat{w}_t\)</span> weights, we can proceed to running the Diff-in-Diff part of the Synthetic DiD estimator. For this part, it is better if we work with the data in the format of a table with <span class="math notranslate nohighlight">\(N\)</span> by <span class="math notranslate nohighlight">\(T\)</span> rows, where we have columns for the states, the years, the outcome, the post-treatment indicator and the treated unit indicator. To that table, we will add the time and unit weights. Since the time weight is in a series with a time index and the unit weights is in another series with unit index, we can simply join everything together.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">join_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit_w</span><span class="p">,</span> <span class="n">time_w</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">data</span>
        <span class="o">.</span><span class="n">set_index</span><span class="p">([</span><span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">])</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">time_w</span><span class="p">)</span>
        <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unit_w</span><span class="p">)</span>
        <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="o">.</span><span class="n">fillna</span><span class="p">({</span><span class="n">time_w</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">year_col</span><span class="p">])),</span>
                 <span class="n">unit_w</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="mi">1</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">state_col</span><span class="p">]))})</span>
        <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;weights&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">time_w</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">*</span> <span class="n">d</span><span class="p">[</span><span class="n">unit_w</span><span class="o">.</span><span class="n">name</span><span class="p">])</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">10</span><span class="p">)})</span>
        <span class="o">.</span><span class="n">astype</span><span class="p">({</span><span class="n">treat_col</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">post_col</span><span class="p">:</span> <span class="nb">int</span><span class="p">}))</span>
</pre></div>
</div>
</div>
</div>
<p>This joining process will leave <code class="docutils literal notranslate"><span class="pre">null</span></code> for the unit weights in the treated group and for the time weights in the post-treatment period. Fortunately, because we use uniform weighting in both cases, it is pretty easy to fill out those <code class="docutils literal notranslate"><span class="pre">null</span></code>s. For the time weights, we fill with the average of the post-treatment dummy, which will be <span class="math notranslate nohighlight">\(1/T_{post}\)</span>; for the unit weights, we fill with the average of the treated dummy, which will be <span class="math notranslate nohighlight">\(1/N_{tr}\)</span>. Finally, we multiply both weights together.</p>
<p>Here is the result we get by running this code on the Proposition 99 data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">did_data</span> <span class="o">=</span> <span class="n">join_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit_weights</span><span class="p">,</span> <span class="n">time_weights</span><span class="p">,</span>
                        <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                        <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                        <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                        <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>

<span class="n">did_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>year</th>
      <th>state</th>
      <th>cigsale</th>
      <th>treated</th>
      <th>after_treatment</th>
      <th>time_weights</th>
      <th>unit_weights</th>
      <th>weights</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>1970</td>
      <td>1</td>
      <td>89.800003</td>
      <td>0</td>
      <td>0</td>
      <td>-4.600034e-14</td>
      <td>-1.360835e-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>1971</td>
      <td>1</td>
      <td>95.400002</td>
      <td>0</td>
      <td>0</td>
      <td>-4.582315e-14</td>
      <td>-1.360835e-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>1972</td>
      <td>1</td>
      <td>101.099998</td>
      <td>0</td>
      <td>0</td>
      <td>-5.274190e-14</td>
      <td>-1.360835e-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>1973</td>
      <td>1</td>
      <td>102.900002</td>
      <td>0</td>
      <td>0</td>
      <td>-5.766356e-14</td>
      <td>-1.360835e-16</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>1974</td>
      <td>1</td>
      <td>108.199997</td>
      <td>0</td>
      <td>0</td>
      <td>-5.617979e-14</td>
      <td>-1.360835e-16</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.3870967741935484
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="mi">1</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;after_treatment==1&quot;</span><span class="p">)[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>0.08333333333333333
</pre></div>
</div>
</div>
</div>
<p>Finally, all we have to do is estimate a Diff-in-Diff model with the weights we’ve just defined. The parameter estimate associated with the interaction term for the post-treatment period and treated dummy will be the Synthetic Difference-in-Differences estimate for the <span class="math notranslate nohighlight">\(ATT\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">did_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">wls</span><span class="p">(</span><span class="s2">&quot;cigsale ~ after_treatment*treated&quot;</span><span class="p">,</span>
                    <span class="n">data</span><span class="o">=</span><span class="n">did_data</span><span class="p">,</span>
                    <span class="n">weights</span><span class="o">=</span><span class="n">did_data</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="n">did_model</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span><span class="o">.</span><span class="n">tables</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="simpletable">
<tr>
             <td></td>                <th>coef</th>     <th>std err</th>      <th>t</th>      <th>P>|t|</th>  <th>[0.025</th>    <th>0.975]</th>  
</tr>
<tr>
  <th>Intercept</th>               <td>  120.4060</td> <td>    1.272</td> <td>   94.665</td> <td> 0.000</td> <td>  117.911</td> <td>  122.901</td>
</tr>
<tr>
  <th>after_treatment</th>         <td>  -19.1905</td> <td>    1.799</td> <td>  -10.669</td> <td> 0.000</td> <td>  -22.720</td> <td>  -15.661</td>
</tr>
<tr>
  <th>treated</th>                 <td>  -25.2601</td> <td>    1.799</td> <td>  -14.043</td> <td> 0.000</td> <td>  -28.789</td> <td>  -21.731</td>
</tr>
<tr>
  <th>after_treatment:treated</th> <td>  -15.6054</td> <td>    2.544</td> <td>   -6.135</td> <td> 0.000</td> <td>  -20.596</td> <td>  -10.615</td>
</tr>
</table></div></div>
</div>
<p>This estimate is much smaller than the one we get with Diff-in-Diff, but that is not surprising. As we’ve already discussed, the Diff-in-Diff estimator is probably biased in this case, since we have pretty good reasons to question the parallel trends assumption. What is perhaps less obvious is why the SDID estimate is smaller than the traditional SC estimate. If we go back and look at the SC plot, we can see that cigarette sales in California started to fall below its synthetic control prior to Proposition 99. This is probably due to the fact that traditional Synthetic Control has to match treated and control units in the entire pre-treatment period, causing it to miss one year or the other. This is less of an issue in SDID, since the time weights allow us to focus just on the periods that are more similar to the post-intervention period. In this case, those were precisely the three years anteceding Proposition 99.</p>
<p>To grasp what SDID is doing, we can plot the Diff-in-Diff lines for the treated (California) and the SDID Synthetic Control. Notice how we are projecting the trend we see in the synthetic control onto the treated unit to get the counterfactual <span class="math notranslate nohighlight">\(Y(0)_{tr, post}\)</span>. The difference between the dashed purple line and the lower solid purple line is the <span class="math notranslate nohighlight">\(ATT\)</span>. We start those lines in 1987 to show how the time weights zero out all periods but 1986, 87 and 88. The time weights are also shown in the small plot down below.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">avg_pre_period</span> <span class="o">=</span> <span class="p">(</span><span class="n">time_weights</span> <span class="o">*</span> <span class="n">time_weights</span><span class="o">.</span><span class="n">index</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">avg_post_period</span> <span class="o">=</span> <span class="mi">1989</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2000</span> <span class="o">-</span> <span class="mi">1989</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

<span class="n">fig</span><span class="p">,</span> <span class="p">(</span><span class="n">ax1</span><span class="p">,</span> <span class="n">ax2</span><span class="p">)</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">8</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">gridspec_kw</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;height_ratios&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">]})</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">sc_did</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">data_piv</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Synthetic Control (SDID)&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">1989</span><span class="p">,</span> <span class="n">data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">(),</span> <span class="n">sc_did</span><span class="o">.</span><span class="n">max</span><span class="p">(),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Prop. 99&quot;</span><span class="p">)</span>

<span class="n">pre_sc</span> <span class="o">=</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;Intercept&quot;</span><span class="p">]</span>
<span class="n">post_sc</span> <span class="o">=</span> <span class="n">pre_sc</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">]</span>
<span class="n">pre_treat</span> <span class="o">=</span> <span class="n">pre_sc</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treated&quot;</span><span class="p">]</span>
<span class="n">post_treat</span> <span class="o">=</span> <span class="n">post_sc</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;treated&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;after_treatment:treated&quot;</span><span class="p">]</span>

<span class="n">sc_did_y0</span> <span class="o">=</span> <span class="n">pre_treat</span> <span class="o">+</span> <span class="p">(</span><span class="n">post_sc</span> <span class="o">-</span> <span class="n">pre_sc</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg_pre_period</span><span class="p">,</span> <span class="n">avg_post_period</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_sc</span><span class="p">,</span> <span class="n">post_sc</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg_pre_period</span><span class="p">,</span> <span class="n">avg_post_period</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_treat</span><span class="p">,</span> <span class="n">post_treat</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">avg_pre_period</span><span class="p">,</span> <span class="n">avg_post_period</span><span class="p">],</span> <span class="p">[</span><span class="n">pre_treat</span><span class="p">,</span> <span class="n">sc_did_y0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C2&quot;</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="s1">&#39;ATT&#39;</span><span class="p">,</span> <span class="n">xy</span><span class="o">=</span><span class="p">(</span><span class="mi">1995</span><span class="p">,</span> <span class="mi">69</span><span class="p">),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">1996</span><span class="p">,</span> <span class="mf">66.5</span><span class="p">),</span> 
            <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">ha</span><span class="o">=</span><span class="s1">&#39;center&#39;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s1">&#39;bottom&#39;</span><span class="p">,</span>
            <span class="n">bbox</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">boxstyle</span><span class="o">=</span><span class="s1">&#39;square&#39;</span><span class="p">,</span> <span class="n">fc</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">),</span>
            <span class="n">arrowprops</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">arrowstyle</span><span class="o">=</span><span class="s1">&#39;-[, widthB=1.5, lengthB=0.5&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;Synthetic Diff-in-Diff&quot;</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">time_weights</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">time_weights</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="mi">1989</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dotted&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Time Weights&quot;</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;Years&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_46_0.png" src="_images/25-Synthetic-Diff-in-Diff_46_0.png" />
</div>
</div>
<p>The above estimator estimates the <span class="math notranslate nohighlight">\(ATT\)</span> which is the effect of Propostion 99 on California averaged out across all post-treatment time periods. But, from the above plot, it looks like the effect increases over time. What if we want to take that into account? Fortunately, it is very straightforward to do that.</p>
<p>Before we move on, just a word of caution about the above estimator. You should <strong>not</strong> trust the standard errors or confidence intervals reported by the regression we just ran. They don’t reflect the variance in estimating the weights. We will take a look at how to do proper inference briefly, but first, let’s see how to deal with effect heterogeneity across time.</p>
</section>
<section id="time-effect-heterogeneity-and-staggered-adoption">
<h2>Time Effect Heterogeneity and Staggered Adoption<a class="headerlink" href="#time-effect-heterogeneity-and-staggered-adoption" title="Permalink to this headline">#</a></h2>
<p>Fortunately, it is incredibly easy to estimate one effect for each time period using SDID. All we have to do is run it multiple times, one for each time period. To be more precise, let’s say we have the following treatment assignment matrix, with just 4 time periods and 3 units. The last unit is the treated one.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_3 &amp; 0_3 &amp; 1_3 \\
    0_4 &amp; 0_4 &amp; 1_4 \\
\end{bmatrix}
\end{split}\]</div>
<p>Running SDID with the above matrix would give us the average <span class="math notranslate nohighlight">\(ATT\)</span> across periods 3 and 4. What we can do to estimate the effect on each period individually is simply to partition the problem into two, one for each post-treatment time period. Then, we run SDID on the data where we only keep post-treatment period 3 and again on the data where we only keep post-treatment period 4. That is, we run SDID on each of the following matrices individually.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D_1 = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_3 &amp; 0_3 &amp; 1_3 \\
\end{bmatrix}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
D_2 = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_4 &amp; 0_4 &amp; 1_4 \\
\end{bmatrix}
\end{split}\]</div>
<p>To do that, it would be best if we first merge all the steps of SDID into a single function. That is, estimating the unit and time weights and running DiD.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">synthetic_diff_in_diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
    
    <span class="c1"># find the unit weights</span>
    <span class="n">unit_weights</span> <span class="o">=</span> <span class="n">fit_unit_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">outcome_col</span><span class="o">=</span><span class="n">outcome_col</span><span class="p">,</span>
                                    <span class="n">year_col</span><span class="o">=</span><span class="n">year_col</span><span class="p">,</span>
                                    <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span>
                                    <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">,</span>
                                    <span class="n">post_col</span><span class="o">=</span><span class="n">post_col</span><span class="p">)</span>
    
    <span class="c1"># find the time weights</span>
    <span class="n">time_weights</span> <span class="o">=</span> <span class="n">fit_time_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                    <span class="n">outcome_col</span><span class="o">=</span><span class="n">outcome_col</span><span class="p">,</span>
                                    <span class="n">year_col</span><span class="o">=</span><span class="n">year_col</span><span class="p">,</span>
                                    <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span>
                                    <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">,</span>
                                    <span class="n">post_col</span><span class="o">=</span><span class="n">post_col</span><span class="p">)</span>

    <span class="c1"># join weights into DiD Data</span>
    <span class="n">did_data</span> <span class="o">=</span> <span class="n">join_weights</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">unit_weights</span><span class="p">,</span> <span class="n">time_weights</span><span class="p">,</span>
                            <span class="n">year_col</span><span class="o">=</span><span class="n">year_col</span><span class="p">,</span>
                            <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span>
                            <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">,</span>
                            <span class="n">post_col</span><span class="o">=</span><span class="n">post_col</span><span class="p">)</span>
    
    <span class="c1"># run DiD</span>
    <span class="n">formula</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">outcome_col</span><span class="si">}</span><span class="s2"> ~ </span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">*</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="n">did_model</span> <span class="o">=</span> <span class="n">smf</span><span class="o">.</span><span class="n">wls</span><span class="p">(</span><span class="n">formula</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">did_data</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">did_data</span><span class="p">[</span><span class="s2">&quot;weights&quot;</span><span class="p">]</span><span class="o">+</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">did_model</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span>


<span class="n">synthetic_diff_in_diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                       <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                       <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                       <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                       <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>-15.605397234587002
</pre></div>
</div>
</div>
</div>
<p>Now that we have a way of easily running SDID, we can run it multiple times, filtering out all the post-treatment periods except the one for which we want the effect.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">effects</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span><span class="p">:</span> <span class="n">synthetic_diff_in_diff</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~after_treatment|(year==</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span> 
                                        <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                        <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                        <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                        <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                        <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
           <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1989</span><span class="p">,</span> <span class="mi">2001</span><span class="p">)}</span>

<span class="n">effects</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">effects</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">effects</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Effect in Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;SDID Effect Estimate by Year&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_51_0.png" src="_images/25-Synthetic-Diff-in-Diff_51_0.png" />
</div>
</div>
<p>As expected, the effect gets bigger as time passes. It starts small, but it gradually increases to what seems like a decrease in consumption of 25 cigarette packs per capita in 2020.</p>
<p>Conveniently, running multiple SDID will also be important to deal with the staggered adoption case. With staggered addoption design, we have multiple treated units, which get the treatment at different time periods. For example, going back to our very simple assignment matrix, with 3 units and 4 time periods, let’s say unit 1 never gets the treatment, unit 2 gets the treatment at period 4 and unit 3 gets the treatment at period 3. This would result in the following matrix</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_3 &amp; 0_3 &amp; 1_3 \\
    0_4 &amp; 1_4 &amp; 1_4 \\
\end{bmatrix}
\end{split}\]</div>
<p>Notice that SDID can’t handle that matrix, because we don’t have a clear definition about what is a pre-treatment period (before time 4, in the case of the second unit or before period 3, in the case of the second unit) or what is a control unit (unit 2 could be a control for the treatment starting at period 3). The key in solving this is realizing we can delete columns (units) or rows (time periods) in that matrix in order to go back to the block assignment design.</p>
<p>For example, we can create two block matrices from the one above by first deleting the 3rd time period and then another one where we delete the 4th time period.</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D_1 = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_4 &amp; 1_4 &amp; 1_4 \\
\end{bmatrix}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
D_2 = \begin{bmatrix}
    0_1 &amp; 0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 &amp; 0_2 \\
    0_3 &amp; 0_3 &amp; 1_3 \\
\end{bmatrix}
\end{split}\]</div>
<p>The result is two block matrices, which means we can run SDID in both of them. The result will be two <span class="math notranslate nohighlight">\(ATT\)</span> estimates, which we can then combine with a weighted average, where the weights are the proportion of treated time and periods in each block. In our example, the weight for <span class="math notranslate nohighlight">\(ATT_1\)</span> would be <span class="math notranslate nohighlight">\(2/3\)</span> and the weight for <span class="math notranslate nohighlight">\(ATT_2\)</span> would be 1/3.</p>
<p>Alternatively, we could also have 2 block designs by removing columns, which would result in the following matrices</p>
<div class="math notranslate nohighlight">
\[\begin{split}
D_1 = \begin{bmatrix}
    0_1 &amp; 0_1  \\
    0_2 &amp; 0_2  \\
    0_3 &amp; 0_3  \\
    0_4 &amp; 1_4  \\
\end{bmatrix}
\end{split}\]</div>
<div class="math notranslate nohighlight">
\[\begin{split}
D_2 = \begin{bmatrix}
    0_1 &amp; 0_1 \\
    0_2 &amp; 0_2 \\
    0_3 &amp; 1_3 \\
    0_4 &amp; 1_4 \\
\end{bmatrix}
\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(D_1\)</span> has units 1 and 2 and <span class="math notranslate nohighlight">\(D_2\)</span> has units 1 and 4.</p>
<p>Since we already saw how to estimate SDID for different time periods, let’s look at this approach where we filter out units. Since we don’t originally have a staggered adoption design in our Proposition 99 data, let’s instead simulate one. We’ll create 3 new states from our data and pretend they pass a law similar to Proposition 99, but in the year 1993. Maybe they were impressed with the results in California and wanted to try in their states too. Once they do, this law that they pass decreases cigarette consumption by 3% each year. We can visualize the average cigarette consumption for those  new states to better understand what is going on. In dashed black, we have the year in which these states pass this anti-tobacco law.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">tr_state</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
            <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;state.isin(</span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;state&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">(),</span> <span class="n">n</span><span class="p">))</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span>
                <span class="s2">&quot;treated&quot;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
                <span class="s2">&quot;state&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="s2">&quot;new_&quot;</span> <span class="o">+</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">),</span>
                <span class="s2">&quot;after_treatment&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">1992</span>
            <span class="p">})</span>
            <span class="c1"># effect of 3% / year</span>
            <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;cigsale&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span> <span class="o">-</span> 
                                                             <span class="n">d</span><span class="p">[</span><span class="s2">&quot;cigsale&quot;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mf">0.03</span><span class="o">*</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1992</span><span class="p">))</span><span class="o">*</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">],</span> <span class="mi">1</span><span class="p">)}))</span>

<span class="n">new_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">data</span><span class="p">,</span> <span class="n">tr_state</span><span class="p">])</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="s2">&quot;treated&quot;</span><span class="p">],</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">],</span> <span class="kc">False</span><span class="p">)})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">new_data_piv</span> <span class="o">=</span> <span class="n">new_data</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="s2">&quot;cigsale&quot;</span><span class="p">)</span>

<span class="n">new_tr_states</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;new&quot;</span><span class="p">),</span> <span class="n">new_data_piv</span><span class="o">.</span><span class="n">columns</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_data_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">new_tr_states</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_data_piv</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">]</span><span class="o">+</span><span class="n">new_tr_states</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">lw</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C1&quot;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Control Avg.&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_data_piv</span><span class="p">[</span><span class="s2">&quot;california&quot;</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;California&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">new_data_piv</span><span class="p">[</span><span class="n">new_tr_states</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C4&quot;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;New Tr State&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1988</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;Proposition 99&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">vlines</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="mi">1992</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">40</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">&quot;dashed&quot;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">&quot;New State Tr.&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;black&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Two Treatment Groups&quot;</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_54_0.png" src="_images/25-Synthetic-Diff-in-Diff_54_0.png" />
</div>
</div>
<p>We finally have this staggered adoption data. Now, we need to figure out how to filter out some states so we can break the problem into multiple block assignment cases. First, we can group states by when they passed the law. The following code does exactly that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">assignment_blocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated &amp; after_treatment&quot;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;state&quot;</span><span class="p">)[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
                     <span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
                     <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>

<span class="n">assignment_blocks</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{1989: [&#39;california&#39;], 1993: [&#39;new_13&#39;, &#39;new_38&#39;, &#39;new_9&#39;]}
</pre></div>
</div>
</div>
</div>
<p>As you can see, we have two groups of states. One with only California, which was treated starting in 1989, and another with the three new states we’ve created, which were all treated starting in 1993. Now, we need to run SDID for each of those groups. We can easily do that, but keeping just the control units plus one of those groups. There is a catch, though. The <code class="docutils literal notranslate"><span class="pre">after_treatment</span></code> column will have a different meaning, depending on which group we are looking at. If we are looking at the group containing only California, <code class="docutils literal notranslate"><span class="pre">after_treatment</span></code> should be <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">&gt;=</span> <span class="pre">1989</span></code>; if we are looking at the group with the new states, it should be <code class="docutils literal notranslate"><span class="pre">year</span> <span class="pre">&gt;=</span> <span class="pre">1993</span></code>. Fortunately, this is pretty easy to account for. All we need is to recreate the <code class="docutils literal notranslate"><span class="pre">after_treatment</span></code> in each iteration.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">staggered_effects</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span><span class="p">:</span> <span class="n">synthetic_diff_in_diff</span><span class="p">(</span><span class="n">new_data</span>
                                                   <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~treated|(state.isin(</span><span class="si">{</span><span class="n">states</span><span class="si">}</span><span class="s2">))&quot;</span><span class="p">)</span>
                                                   <span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">d</span><span class="p">:</span> <span class="n">d</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">year</span><span class="p">}),</span>
                                                  <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                                  <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                                  <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                                  <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                                  <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
                     <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">assignment_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">staggered_effects</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>{1989: -15.605397234587002, 1993: -17.249435402003648}
</pre></div>
</div>
</div>
</div>
<p>Not surprisingly, the <span class="math notranslate nohighlight">\(ATT\)</span> estimate for the first group, the one with only California, is exactly the same as the one we’ve seen before. The other <span class="math notranslate nohighlight">\(ATT\)</span> refers to the one we get with the new group of states. We have to combine them into a single <span class="math notranslate nohighlight">\(ATT\)</span>. This can be done with the weighted average we’ve explained earlier.</p>
<p>First, we calculate the number of treated entries (<code class="docutils literal notranslate"><span class="pre">after_treatment</span> <span class="pre">&amp;</span> <span class="pre">treated</span></code>) in each block. Then, we combine the <span class="math notranslate nohighlight">\(ATT\)</span>s using those weights.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">weights</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span><span class="p">:</span> <span class="nb">sum</span><span class="p">((</span><span class="n">new_data</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">year</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">new_data</span><span class="p">[</span><span class="s2">&quot;state&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">states</span><span class="p">)))</span>
           <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">states</span> <span class="ow">in</span> <span class="n">assignment_blocks</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

<span class="n">att</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">effect</span><span class="o">*</span><span class="n">weights</span><span class="p">[</span><span class="n">year</span><span class="p">]</span><span class="o">/</span><span class="nb">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">values</span><span class="p">())</span> <span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">effect</span> <span class="ow">in</span> <span class="n">staggered_effects</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;weights: &quot;</span><span class="p">,</span> <span class="n">weights</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;ATT: &quot;</span><span class="p">,</span> <span class="n">att</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>weights:  {1989: 12, 1993: 24}
ATT:  -16.701422679531433
</pre></div>
</div>
</div>
</div>
<p>Here, we have a total of 36 treatment instances: the usual 12 post-treatment periods for California plus 8 treatment periods (1993-2000) for each of the three new treatment states we’ve introduced. With that in mind, the weight for the first <span class="math notranslate nohighlight">\(ATT\)</span> is <span class="math notranslate nohighlight">\(12/36\)</span> and for the second <span class="math notranslate nohighlight">\(ATT\)</span>, <span class="math notranslate nohighlight">\(24/36\)</span>, which combines to the result above.</p>
</section>
<section id="placebo-variance-estimation">
<h2>Placebo Variance Estimation<a class="headerlink" href="#placebo-variance-estimation" title="Permalink to this headline">#</a></h2>
<p>This chapter is getting a bit too long, but there is one promise we haven’t fulfilled yet. Remember how we said, in the very beginning, that SDID has better precision (lower error bars) when compared to Synthetic Controls? The reason is that the time and unit fixed effects in SDID capture a ton of the variation in the outcome, which in turn, reduces the variance of the estimator.</p>
<p>Of course I wouldn’t ask you to take my word for it, so next, we’ll show how to place a confidence interval around the SDID estimate. It turns out there are many solutions to this problem, but only one that fits the case for a single treated unit, which is the case we have here since only California was treated. The idea is to run a series of placebo tests, where we pretend a unit from the control pool is treated, when it actually isn’t. Then, we use SDID to estimate the <span class="math notranslate nohighlight">\(ATT\)</span> of this placebo test and store its result. We re-run this step multiple times, sampling a control unit each time. In the end, we will have an array of placebo <span class="math notranslate nohighlight">\(ATT\)</span>s. The variance of this array is the placebo variance of the SDID effect estimate, which we can use to construct a confidence interval.</p>
<div class="math notranslate nohighlight">
\[
\hat{V}^{placebo}_{\tau} = B^{-1}\sum_{b=1}^B\bigg(\hat{\tau}^{(b)} - \bar{\hat{\tau}}^{(b)}\bigg)^2
\]</div>
<div class="math notranslate nohighlight">
\[
\tau \in \hat{\tau}^{sdid} \pm \mathcal{z}_{\alpha/2} \sqrt{\hat{V}_{\tau}}
\]</div>
<p>In order to implement this, the first thing we need is a function which creates the placebo. This function will filter out the treated units, sample a single control unit and flip the <code class="docutils literal notranslate"><span class="pre">treated</span></code> column for that control unit from 0 to a 1.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_random_placebo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">):</span>
    <span class="n">control</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">states</span> <span class="o">=</span> <span class="n">control</span><span class="p">[</span><span class="n">state_col</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>
    <span class="n">placebo_state</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">states</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">control</span><span class="o">.</span><span class="n">assign</span><span class="p">(</span><span class="o">**</span><span class="p">{</span><span class="n">treat_col</span><span class="p">:</span> <span class="n">control</span><span class="p">[</span><span class="n">state_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">placebo_state</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">placebo_data</span> <span class="o">=</span> <span class="n">make_random_placebo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span> <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">)</span>

<span class="n">placebo_data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="s2">&quot;treated&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>state</th>
      <th>year</th>
      <th>cigsale</th>
      <th>treated</th>
      <th>after_treatment</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>1204</th>
      <td>39</td>
      <td>1996</td>
      <td>110.300003</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1205</th>
      <td>39</td>
      <td>1997</td>
      <td>108.800003</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1206</th>
      <td>39</td>
      <td>1998</td>
      <td>102.900002</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1207</th>
      <td>39</td>
      <td>1999</td>
      <td>104.800003</td>
      <td>True</td>
      <td>True</td>
    </tr>
    <tr>
      <th>1208</th>
      <td>39</td>
      <td>2000</td>
      <td>90.500000</td>
      <td>True</td>
      <td>True</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>In the example above, we’ve sampled state 39 and we are now pretending that it was treated. Notice how the <code class="docutils literal notranslate"><span class="pre">treated</span></code> column was flipped to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>The next thing we need is to compute the SDID estimate with this placebo data and repeat that a bunch of times. The next function does that. It runs the <code class="docutils literal notranslate"><span class="pre">synthetic_diff_in_diff</span></code> function to get the SDID estimate, but instead of passing the usual data, we pass the result of calling <code class="docutils literal notranslate"><span class="pre">make_random_placebo</span></code>. We do that multiple times to get an array of SDID estimates and, finally, compute the square root of the variance of this array, which is just the standard deviation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">joblib</span> <span class="kn">import</span> <span class="n">Parallel</span><span class="p">,</span> <span class="n">delayed</span> <span class="c1"># for parallel processing</span>


<span class="k">def</span> <span class="nf">estimate_se</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">,</span> <span class="n">bootstrap_rounds</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">njobs</span><span class="o">=</span><span class="mi">4</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    
    <span class="n">sdid_fn</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">synthetic_diff_in_diff</span><span class="p">,</span>
                      <span class="n">outcome_col</span><span class="o">=</span><span class="n">outcome_col</span><span class="p">,</span>
                      <span class="n">year_col</span><span class="o">=</span><span class="n">year_col</span><span class="p">,</span>
                      <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span>
                      <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">,</span>
                      <span class="n">post_col</span><span class="o">=</span><span class="n">post_col</span><span class="p">)</span>
    
    <span class="n">effects</span> <span class="o">=</span> <span class="n">Parallel</span><span class="p">(</span><span class="n">n_jobs</span><span class="o">=</span><span class="n">njobs</span><span class="p">)(</span><span class="n">delayed</span><span class="p">(</span><span class="n">sdid_fn</span><span class="p">)(</span><span class="n">make_random_placebo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">))</span>
                                     <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap_rounds</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effects</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">effect</span> <span class="o">=</span> <span class="n">synthetic_diff_in_diff</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                                <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>


<span class="n">se</span> <span class="o">=</span> <span class="n">estimate_se</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                 <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                 <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                 <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                 <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                 <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The standard deviation can then be used to construct confidence intervals much like we described in the formula above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect: </span><span class="si">{</span><span class="n">effect</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standard Error: </span><span class="si">{</span><span class="n">se</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;90% CI: (</span><span class="si">{</span><span class="n">effect</span><span class="o">-</span><span class="mf">1.65</span><span class="o">*</span><span class="n">se</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">effect</span><span class="o">+</span><span class="mf">1.65</span><span class="o">*</span><span class="n">se</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effect: -15.605397234587002
Standard Error: 9.912089736240311
90% CI: (-31.960345299383516, 0.7495508302095111)
</pre></div>
</div>
</div>
</div>
<p>Notice that the <span class="math notranslate nohighlight">\(ATT\)</span> is not significant in this case, but what’s more interesting here is to compare the standard error of the SDID estimate with the one we get from traditional Synthetic Control.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">synthetic_control</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">):</span>
    
    <span class="n">x_pre_control</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                     <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">)</span>
                     <span class="o">.</span><span class="n">values</span><span class="p">)</span>
    
    <span class="n">y_pre_treat_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
                        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                        <span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">year_col</span><span class="p">)</span>
                        <span class="p">[</span><span class="n">outcome_col</span><span class="p">]</span>
                        <span class="o">.</span><span class="n">mean</span><span class="p">())</span>
    
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">x_pre_control</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">objective</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum_squares</span><span class="p">(</span><span class="n">x_pre_control</span><span class="nd">@w</span> <span class="o">-</span> <span class="n">y_pre_treat_mean</span><span class="o">.</span><span class="n">values</span><span class="p">))</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">]</span>
    
    <span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="n">constraints</span><span class="p">)</span>
    <span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">sc</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span>
          <span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
          <span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">)</span>
          <span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">@</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
    
    <span class="n">y1</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">treat_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">post_col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)[</span><span class="n">outcome_col</span><span class="p">]</span>
    <span class="n">att</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">y1</span> <span class="o">-</span> <span class="n">sc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">y1</span><span class="p">):])</span>
    
    <span class="k">return</span> <span class="n">att</span>


<span class="k">def</span> <span class="nf">estimate_se_sc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">outcome_col</span><span class="p">,</span> <span class="n">year_col</span><span class="p">,</span> <span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="p">,</span> <span class="n">post_col</span><span class="p">,</span> <span class="n">bootstrap_rounds</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
    <span class="n">effects</span> <span class="o">=</span> <span class="p">[</span><span class="n">synthetic_control</span><span class="p">(</span><span class="n">make_random_placebo</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span> <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">),</span> 
                                 <span class="n">outcome_col</span><span class="o">=</span><span class="n">outcome_col</span><span class="p">,</span>
                                 <span class="n">year_col</span><span class="o">=</span><span class="n">year_col</span><span class="p">,</span>
                                 <span class="n">state_col</span><span class="o">=</span><span class="n">state_col</span><span class="p">,</span>
                                 <span class="n">treat_col</span><span class="o">=</span><span class="n">treat_col</span><span class="p">,</span>
                                 <span class="n">post_col</span><span class="o">=</span><span class="n">post_col</span><span class="p">)</span>
              <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bootstrap_rounds</span><span class="p">)]</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">effects</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>


<span class="n">effect_sc</span> <span class="o">=</span> <span class="n">synthetic_control</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                              <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                              <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                              <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                              <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                              <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>


<span class="n">se_sc</span> <span class="o">=</span> <span class="n">estimate_se_sc</span><span class="p">(</span><span class="n">data</span><span class="p">,</span>
                       <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                       <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                       <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                       <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                       <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Effect: </span><span class="si">{</span><span class="n">effect_sc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Standard Error: </span><span class="si">{</span><span class="n">se_sc</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;90% CI: (</span><span class="si">{</span><span class="n">effect_sc</span><span class="o">-</span><span class="mf">1.65</span><span class="o">*</span><span class="n">se_sc</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">effect_sc</span><span class="o">+</span><span class="mf">1.65</span><span class="o">*</span><span class="n">se_sc</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Effect: -19.513629763998537
Standard Error: 11.2419349486209
90% CI: (-38.06282242922302, -0.9644370987740523)
</pre></div>
</div>
</div>
</div>
<p>Notice how the error for synthetic control is higher than for SDID. Again, that is because SDID captures a lot of the variance in the outcome via its time and unit fixed effects. With this, we fulfill the promise we made earlier. But, before we close, it is worth mentioning that we can also use the same procedure to estimate the variance to make a confidence interval around the effect we’ve estimated for each post-treatment time period. All we need to do is run the code above once for each time period. Just keep in mind that this might take some time to run, even with the parallelization we’ve implemented.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">standard_errors</span> <span class="o">=</span> <span class="p">{</span><span class="n">year</span><span class="p">:</span> <span class="n">estimate_se</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;~after_treatment|(year==</span><span class="si">{</span><span class="n">year</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">),</span> 
                                     <span class="n">outcome_col</span><span class="o">=</span><span class="s2">&quot;cigsale&quot;</span><span class="p">,</span>
                                     <span class="n">year_col</span><span class="o">=</span><span class="s2">&quot;year&quot;</span><span class="p">,</span>
                                     <span class="n">state_col</span><span class="o">=</span><span class="s2">&quot;state&quot;</span><span class="p">,</span>
                                     <span class="n">treat_col</span><span class="o">=</span><span class="s2">&quot;treated&quot;</span><span class="p">,</span>
                                     <span class="n">post_col</span><span class="o">=</span><span class="s2">&quot;after_treatment&quot;</span><span class="p">)</span>
                   <span class="k">for</span> <span class="n">year</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1989</span><span class="p">,</span> <span class="mi">2001</span><span class="p">)}</span>

<span class="n">standard_errors</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">standard_errors</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">effects</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">effects</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">effects</span><span class="o">-</span><span class="mf">1.65</span><span class="o">*</span><span class="n">standard_errors</span><span class="p">,</span> <span class="n">effects</span><span class="o">+</span><span class="mf">1.65</span><span class="o">*</span><span class="n">standard_errors</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s2">&quot;C0&quot;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Effect in Cigarette Sales&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s2">&quot;Year&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Synthetic DiD 90% Conf. Interval&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">rotation</span><span class="o">=</span><span class="mi">45</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/25-Synthetic-Diff-in-Diff_74_0.png" src="_images/25-Synthetic-Diff-in-Diff_74_0.png" />
</div>
</div>
</section>
<section id="key-concepts">
<h2>Key Concepts<a class="headerlink" href="#key-concepts" title="Permalink to this headline">#</a></h2>
<p>Synthetic-Diff-in-Diff (SDID) draws inspiration from both Diff-in-Diff and Synthetic Control, which brings advantages from both models.  Like SC, SDID still works with multiple periods when pre-treatment trends are not parallel. However, unlike SC, SDID estimates unit weights to build a control unit which is only parallel to the treated group (it doesn’t have to match its level). From DID, SDID leverages time and unit fixed effects, which helps to explain a lot of the variance in the outcome, which in turn reduces the variance of the SDID estimator. Synthetic-Diff-in-Diff also introduces some new ideas of its own. First, there is an additional <span class="math notranslate nohighlight">\(L2\)</span> penalty in the optimization of the unit weights which makes them more spread out across control units. Second, SDID allows for an intercept (and hence, extrapolation) when building such weights. Third, SDID introduces the use of time weights, which are not present in either DID nor SC. For this reason, I wouldn’t say SDID is just merging SC and SDID. It is rather building something new, inspired by these two approaches. I also wouldn’t say that SDID is better or worse than traditional Synthetic Control. Each of them have different properties that might be appropriate or not, depending on the situation. For example, you might find yourself in a situation where allowing the extrapolations from SDID is dangerous. In which case, SC might be a good alternative.</p>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">#</a></h2>
<p>This chapter is essentially an explainer to the <em>Synthetic Difference in Differences</em> (2019) article, by Dmitry Arkhangelsky, Susan Athey, David A. Hirshberg, Guido W. Imbens and Stefan Wager. Additionally, I would love to recognize Masa Asami for his python implementation of SDID, pysynthdid. His code helped me make sure I didn’t have any bugs in mine, which was extremely helpful.</p>
</section>
<section id="contribute">
<h2>Contribute<a class="headerlink" href="#contribute" title="Permalink to this headline">#</a></h2>
<p>Causal Inference for the Brave and True is an open-source material on causal inference, the statistics of science. It uses only free software, based in Python. Its goal is to be accessible monetarily and intellectually.
If you found this book valuable and you want to support it, please go to <a class="reference external" href="https://www.patreon.com/causal_inference_for_the_brave_and_true">Patreon</a>. If you are not ready to contribute financially, you can also help by fixing typos, suggesting edits or giving feedback on passages you didn’t understand. Just go to the book’s repository and <a class="reference external" href="https://github.com/matheusfacure/python-causality-handbook/issues">open an issue</a>. Finally, if you liked this content, please share it with others who might find it useful and give it a <a class="reference external" href="https://github.com/matheusfacure/python-causality-handbook/stargazers">star on GitHub</a>.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="24-The-Diff-in-Diff-Saga.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">24 - The Difference-in-Differences Saga</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="Debiasing-with-Orthogonalization.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Debiasing with Orthogonalization</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Matheus Facure Alves<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>